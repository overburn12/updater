
{% extends "base.html" %}

{% block title %}
   {{ servername }} SQL query
{% endblock %}

{% block head %}
{% endblock %}

{% block content %}

{{ block_header(servername)}}
<div style="display: flex;">
    <div style="flex: 1; padding: 10px;">
        <div id="savedQueriesList"></div>
        <button onclick="newQuery()">New</button>
        <button onclick="renameQuery()">Rename</button>
        <button onclick="deleteQuery()">Delete</button>
    </div>
    <div style="flex: 3; padding: 10px;">
        <textarea id="queryInput" style="width: 100%; height: 30em;"></textarea>
        <button onclick="submitQuery()">Run Query</button>
        <button onclick="saveQuery()">Save</button>
        <button onclick="clearOutput()">Clear Output</button>
    </div>
</div>
{{ block_footer() }}

{{block_header('Query Results')}}
<div>
    <input type="text" id="timeColumn" placeholder="Time Column Name">
    <select id="timeGranularity">
        <option value="yearly">Yearly</option>
        <option value="monthly">Monthly</option>
        <option value="daily">Daily</option>
        <option value="hourly">Hourly</option>
        <option value="minutely">Minutely</option>
        <option value="secondly">Secondly</option>
    </select>
    <button onclick="renderChart()">Render Chart</button>
</div>
<canvas id="myChart"></canvas>
<div id="query_results"></div>
{{block_footer()}}

<script>
    function submitQuery() {
        document.getElementById('query_results').innerHTML = '';
        const query = document.getElementById('queryInput').value;
        var server_name = '{{ servername }}';
        fetch('/updater/sql/' + server_name, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: query })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('query_results').innerHTML = createHtmlTableFromData(data);
            console.log('Data received:', data);
        }).catch(error => {
            console.log('catch-error: ', error);
        });
    }

    function createHtmlTableFromData(data) {
        let tableHtml = "<table><thead><tr>";
        data.columns.forEach(column => {
            tableHtml += `<th>${column}</th>`;
        });
        tableHtml += "</tr></thead><tbody>";
        data.rows.forEach(row => {
            tableHtml += "<tr>";
            data.columns.forEach(column => {
                tableHtml += `<td>${row[column]}</td>`;
            });
            tableHtml += "</tr>";
        });
        tableHtml += "</tbody></table>";
        return tableHtml;
    }
    function saveQuery() {
        const title = prompt("Enter a title for the query:");
        if (title) {
            const query = document.getElementById('queryInput').value;
            let queries = JSON.parse(localStorage.getItem('queries')) || [];
            queries.push({ title, query });
            localStorage.setItem('queries', JSON.stringify(queries));
            updateSavedQueriesList();
        }
    }

    function updateSavedQueriesList() {
        let queries = JSON.parse(localStorage.getItem('queries')) || [];
        let listHtml = queries.map((item, index) => 
            `<div onclick="loadQuery(${index})">${index}. ${item.title}</div>`
        ).join('');
        document.getElementById('savedQueriesList').innerHTML = listHtml;
    }

    function loadQuery(index) {
        let queries = JSON.parse(localStorage.getItem('queries'));
        document.getElementById('queryInput').value = queries[index].query;
    }

    function newQuery() {
        document.getElementById('queryInput').value = '';
    }

    function renameQuery() {
        const index = prompt("Enter the index of the query to rename:");
        if (index !== null) {
            const newTitle = prompt("Enter the new title:");
            let queries = JSON.parse(localStorage.getItem('queries'));
            if (queries[index]) {
                queries[index].title = newTitle;
                localStorage.setItem('queries', JSON.stringify(queries));
                updateSavedQueriesList();
            }
        }
    }

    function deleteQuery() {
        const index = prompt("Enter the index of the query to delete:");
        if (index !== null) {
            let queries = JSON.parse(localStorage.getItem('queries'));
            if (queries[index]) {
                queries.splice(index, 1);
                localStorage.setItem('queries', JSON.stringify(queries));
                updateSavedQueriesList();
            }
        }
    }

    function renderChart() {
        const timeColumn = document.getElementById('timeColumn').value;
        const granularity = document.getElementById('timeGranularity').value;
        const queryData = JSON.parse(localStorage.getItem('lastQueryResponse'));

        // Process the data to fit into the chart
        // This will depend on the structure of your queryData
        const processedData = processDataForChart(queryData, timeColumn, granularity);

        const ctx = document.getElementById('myChart').getContext('2d');
        const myChart = new Chart(ctx, {
            type: 'line', // or 'bar', depending on your preference
            data: {
                labels: processedData.labels,
                datasets: [{
                    label: 'Data',
                    data: processedData.data,
                    // other dataset properties
                }]
            },
            options: {
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: granularity
                        }
                    }
                }
            }
        });
    }

    function processDataForChart(data, timeColumn, granularity) {
        // Implement the logic to process queryData into a format suitable for Chart.js
        // This might include parsing date strings, aggregating data, etc.
        // Return an object with 'labels' and 'data' arrays

        return { labels: [], data: [] };
    }

    // Call updateSavedQueriesList to display saved queries on page load
    updateSavedQueriesList();
</script>

{% endblock %}
